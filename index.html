
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>ูุชุงุจุนุฉ ุฅูุจูุฏู Ultra</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0e14"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css?v=52">
  <script>
    // Lazy load Chart.js + zoom plugin only when needed
    async function ensureCharts(){
      if(window.Chart) return;
      await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; s.onload=r; document.head.appendChild(s); });
      await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js'; s.onload=r; document.head.appendChild(s); });
    }
    // jsPDF for PDF report
    async function ensurePDF(){ if(window.jspdf) return; await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'; s.onload=r; document.head.appendChild(s); }); }
    // SW: register and inform page on update (stale-while-revalidate)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js?v=52').then(reg=>{
        reg.addEventListener('updatefound', ()=>{
          const sw=reg.installing; sw.addEventListener('statechange', ()=>{
            if(sw.state==='installed' && navigator.serviceWorker.controller){
              window.postMessage({type:'SW_UPDATED'}, '*');
            }
          });
        });
      });
    }
  </script>
</head>
<body>
<div class="wrap">
  <div class="toolbar" style="margin:8px 4px 12px">
    <div>
      <h1 style="margin:0"><span id="t_appName">ูุชุงุจุนุฉ ุฅูุจูุฏู</span> <span style="opacity:.6">Ultra</span></h1>
      <div class="tag">PWA โ ูุนูู ุฏูู ุฅูุชุฑูุช ุจุนุฏ ุฃูู ูุฑุฉ</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="btnLang" class="ghost">EN</button>
      <button id="btnInstall" class="ghost">ุชุซุจูุช ูุชุทุจูู</button>
      <button id="btnTheme" class="ghost">ูุถุน: <span id="themeName">โ</span></button>
    </div>
  </div>

  <div id="updateBanner" class="update-banner" style="display:none">
    ูู ุฅุตุฏุงุฑ ุฌุฏูุฏ โ <button id="reloadApp" class="ghost">ุชุญุฏูุซ ุงูุขู</button>
  </div>

  <!-- Dashboard -->
  <section class="view" id="view-dashboard">
    <div class="kpis">
      <div class="kpi"><div class="h" id="t_lastWeight">ุขุฎุฑ ูุฒู</div><div class="v" id="kpiWeight">โ</div><div class="delta" id="deltaWeight"></div></div>
      <div class="kpi"><div class="h" id="t_lastFat">ุขุฎุฑ ุฏููู %</div><div class="v" id="kpiBodyFat">โ</div><div class="delta" id="deltaBodyFat"></div></div>
      <div class="kpi"><div class="h">BMI</div><div class="v" id="kpiBMI">โ</div></div>
      <div class="kpi"><div class="h" id="t_goalProg">ุงูุชูุฏู ูุญู ุงููุฏู</div><div class="v" id="kpiGoal">โ</div><div class="delta" id="deltaGoal"></div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title" id="t_chart">ุงูุฑุณู ุงูุจูุงูู</div>
      <div class="chips" style="margin-bottom:8px">
        <button class="chip active" data-range="all" id="t_all">ุงููู</button>
        <button class="chip" data-range="90">90</button>
        <button class="chip" data-range="30">30</button>
        <button class="chip" data-range="7">7</button>
        <button class="chip" id="toggleAvg">ูุชูุณุท 7 ุฃูุงู</button>
        <button class="chip" id="resetZoom">ุฅุนุงุฏุฉ ุถุจุท ุงูุชูุจูุฑ</button>
      </div>
      <canvas id="chart" height="280" aria-label="Weight and Body Fat chart" role="img"></canvas>
      <div class="search" style="margin-top:8px">
        <button id="btnWeeklyPDF" class="ghost">๐ ุชูุฑูุฑ PDF ุฃุณุจูุนู</button>
      </div>
      <p class="tag" id="t_axes">ุงููุฒู ุนูู ุงููุญูุฑ ุงูุฃุณุงุณูุ ูุงูุฏููู % ุนูู ุงููุญูุฑ ุงูุซุงููู.</p>
    </div>
  </section>

  <!-- Add -->
  <section class="view" id="view-add">
    <div class="card">
      <div class="title" id="t_addedit">ุฅุถุงูุฉ / ุชุนุฏูู ูุฑุงุกุฉ</div>
      <div class="grid">
        <div><label id="t_date">ุงูุชุงุฑูุฎ</label><input id="date" type="date"/></div>
        <div><label id="t_wkg">ุงููุฒู (ูุฌู)</label><input id="weight" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label id="t_bfat">ุฏููู %</label><input id="bodyFat" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label id="t_mkg">ุนุถูุงุช (ูุฌู)</label><input id="muscle" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label id="t_waterpct">ูุงุก %</label><input id="water" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label id="t_visc">ุฏููู ุญุดููุฉ</label><input id="visceral" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label id="t_bmr">ูุนุฏู ุงูุญุฑู BMR</label><input id="bmr" type="number" inputmode="numeric" step="1"/></div>
        <div><label>BMI</label><input id="bmi" type="text" disabled/></div>
        <div style="grid-column: 1 / -1"><label id="t_notes">ููุงุญุธุงุช</label><textarea id="notes" rows="2" placeholder="ุงุฎุชูุงุฑู"></textarea></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-preset="today" id="t_today">ุงูููู</button>
        <button class="chip" data-preset="-1" id="t_yesterday">ุฃูุณ</button>
        <button class="chip" data-preset="-7" id="t_weekago">ูุจู ุฃุณุจูุน</button>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveBtn">ุญูุธ ุงููุฑุงุกุฉ</button>
        <button class="ghost" id="cancelBtn">ุฅูุบุงุก</button>
        <button class="ghost" id="copyLast">ุงูุณุฎ ุขุฎุฑ ูุฑุงุกุฉ</button>
      </div>
      <div class="tag" id="autoCalcs">โ</div>
    </div>
  </section>

  <!-- Goals -->
  <section class="view" id="view-goals">
    <div class="card">
      <div class="title" id="t_goals">ุฃูุฏุงู ุงูููุงูุฉ</div>
      <div class="grid">
        <div><label id="t_goalWeight">ูุฏู ุงููุฒู (ูุฌู)</label><input id="goalWeight" type="number" step="0.1" inputmode="decimal"/></div>
        <div><label id="t_goalBF">ูุฏู ุงูุฏููู %</label><input id="goalBodyFat" type="number" step="0.1" inputmode="decimal"/></div>
        <div><label id="t_weekly">ูุนุฏู ุงูุชุบููุฑ ุงูุฃุณุจูุนู (ูุฌู/ุฃุณุจูุน)</label><input id="goalWeekly" type="number" step="0.1" inputmode="decimal" placeholder="-0.5"/></div>
        <div><label id="t_deadline">ููุนุฏ ูุณุชูุฏู (ุงุฎุชูุงุฑู)</label><input id="goalDeadline" type="date"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveGoals">ุญูุธ ุงูุฃูุฏุงู</button>
        <button class="ghost" id="clearGoals">ูุณุญ</button>
      </div>
      <p class="tag" id="etaText"></p>
    </div>
  </section>

  <!-- Water -->
  <section class="view" id="view-water">
    <div class="card">
      <div class="title" id="t_water">ูุงุก ุงูููู</div>
      <div class="ring" aria-label="ูุณุจุฉ ุฅูุฌุงุฒ ุงููุงุก"><div id="waterRing" class="fill"></div><span id="waterPct">0%</span></div>
      <div class="grid" style="margin-top:10px">
        <div><label id="t_waterGoal">ูุฏู ุงููุงุก (ูู)</label><input id="waterGoal" type="number" inputmode="numeric" placeholder="3000"/></div>
        <div><label id="t_currDrink">ุงููุดุฑูุจ ุงูุญุงูู (ูู)</label><input id="waterCustom" type="number" inputmode="numeric" placeholder="250"/></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-add="250">+250 ูู</button>
        <button class="chip" data-add="500">+500 ูู</button>
        <button class="chip" data-add="750">+750 ูู</button>
        <button class="chip" id="addCustom">+ ุฅุถุงูุฉ</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title" id="t_reminder">ุฅุนุฏุงุฏุงุช ุงูุชุฐููุฑ</div>
        <div class="grid">
          <div><label id="t_interval">ูุงุตู ุงูุชุฐููุฑ</label>
            <select id="waterInterval">
              <option value="60">ูู 60 ุฏูููุฉ</option>
              <option value="90" selected>ูู 90 ุฏูููุฉ</option>
              <option value="120">ูู 120 ุฏูููุฉ</option>
            </select>
          </div>
          <div><label id="t_quietStart">ุณุงุนุงุช ุงูุตูุช (ูู)</label><input id="quietStart" type="time" value="22:00"></div>
          <div><label id="t_quietEnd">ุณุงุนุงุช ุงูุตูุช (ุฅูู)</label><input id="quietEnd" type="time" value="08:00"></div>
        </div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="waterReset" class="ghost" style="flex:1">ุฅุนุงุฏุฉ ุถุจุท ุงูููู</button>
        <button id="waterNotify" style="flex:1">ุชูุนูู ุชุฐููุฑ ุงููุงุก</button>
      </div>
      <p class="tag" id="t_foregroundNote">ุงูุชุฐููุฑ ูุนูู ุฏุงุฎู ุงูุชุทุจูู ุนูุฏ ูุชุญู. ูุง ุฅุดุนุงุฑุงุช ุฎูููุฉ.</p>
      <div class="search" style="margin-top:6px">
        <button id="icsBtn" class="ghost" style="flex:1">ุชุฐููุฑ ุชูููู ูู ุณุงุนุชูู (ICS)</button>
      </div>
    </div>
  </section>

  <!-- History (with inline edit, CSV tools, encryption) -->
  <section class="view" id="view-history">
    <div class="card">
      <div class="title" id="t_readings">ุงููุฑุงุกุงุช</div>
      <div class="search" style="margin-bottom:8px">
        <input id="searchNotes" placeholder="ุงุจุญุซ ูู ุงูููุงุญุธุงุช..."/>
        <div class="chips">
          <button class="chip active" data-range="all" id="t_all2">ุงููู</button>
          <button class="chip" data-range="365">ุณูุฉ</button>
          <button class="chip" data-range="90">90</button>
          <button class="chip" data-range="30">30</button>
          <button class="chip" data-range="7">7</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table id="table" aria-label="ุณุฌู ุงููุฑุงุกุงุช">
          <thead><tr>
            <th id="th_date">ุงูุชุงุฑูุฎ</th><th id="th_w">ุงููุฒู</th><th id="th_bf">ุฏููู %</th><th id="th_m">ุนุถูุงุช</th><th id="th_wa">ูุงุก %</th><th id="th_v">ุญุดููุฉ</th><th id="th_bmr">BMR</th><th>BMI</th><th id="th_notes">ููุงุญุธุงุช</th><th id="th_actions">ุฅุฌุฑุงุกุงุช</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="search" style="margin-top:8px;gap:12px">
        <button class="ghost" id="exportBtn">ุชุตุฏูุฑ JSON</button>
        <button class="ghost" id="exportEncBtn">ุชุตุฏูุฑ ูุดููุฑ</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <button class="ghost" id="importBtn">ุงุณุชูุฑุงุฏ</button>
        <input type="file" id="importCSVFile" accept=".csv,text/csv" style="display:none"/>
        <button class="ghost" id="importCSVBtn">ุงุณุชูุฑุงุฏ CSV</button>
        <button class="ghost" id="exportCSVBtn">ุชุตุฏูุฑ CSV</button>
      </div>
    </div>
  </section>

  <!-- Settings + Diagnostics -->
  <section class="view" id="view-settings">
    <div class="card">
      <div class="title" id="t_settings">ุงูุฅุนุฏุงุฏุงุช</div>
      <div class="grid">
        <div><label id="t_height">ุงูุทูู (ุณู)</label><input id="height" type="number" inputmode="decimal" placeholder="173"/></div>
        <div><label>PIN</label><input id="pin" type="password" inputmode="numeric" minlength="4" maxlength="6" placeholder="4-6"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveSettings">ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
        <button class="ghost" id="clearAll">ูุณุญ ูู ุงูุจูุงูุงุช (ุชุญุฐูุฑ)</button>
        <button class="ghost" id="btnDiagnostics">ุชุดุฎูุต</button>
      </div>
      <p class="tag" id="t_localOnly">ุชูุฎุฒู ุงูุจูุงูุงุช ูุญูููุง ุนูู ุฌูุงุฒู ููุท.</p>
    </div>
    <div class="card" id="diagCard" style="display:none;margin-top:10px">
      <div class="title">Diagnostics</div>
      <div class="kv">
        <div>UA</div><div id="ua"></div>
        <div>localStorage</div><div id="lsOK"></div>
        <div>Notifications</div><div id="notif"></div>
        <div>SW</div><div id="sw"></div>
      </div>
    </div>
  </section>
</div>

<nav class="tabs" role="tablist">
  <button class="tab" data-view="dashboard" role="tab">ููุญุฉ</button>
  <button class="tab" data-view="add" role="tab">ุฅุถุงูุฉ</button>
  <button class="tab" data-view="goals" role="tab">ุฃูุฏุงู</button>
  <button class="tab" data-view="water" role="tab">ูุงุก</button>
  <button class="tab" data-view="history" role="tab">ูุฑุงุกุงุช</button>
  <button class="tab" data-view="settings" role="tab">ุฅุนุฏุงุฏุงุช</button>
</nav>

<!-- Onboarding Modal -->
<div class="modal" id="onboardModal" role="dialog" aria-modal="true" aria-labelledby="onbTitle">
  <div class="box">
    <h3 id="onbTitle">ุชููุฆุฉ ุณุฑูุนุฉ</h3>
    <div class="grid">
      <div><label>ุงูุทูู (ุณู)</label><input id="onbHeight" type="number" placeholder="173"></div>
      <div><label>ูุฏู ุงููุงุก (ูู)</label><input id="onbWater" type="number" placeholder="3000" value="3000"></div>
      <div><label>ุงููุฒู ุงูุญุงูู (ูุฌู)</label><input id="onbWeight" type="number" step="0.1"></div>
      <div><label>ูุฏู ุงููุฒู (ูุฌู)</label><input id="onbGoalWeight" type="number" step="0.1"></div>
    </div>
    <p class="tag">ููุถูู ุจูุงูุงุช ุชุฌุฑูุจูุฉ ููุฏุฉ 14 ููู ุนุดุงู ุงูุฌุฑุงู ูุจุงู ููุฑูุง. ุชูุฏุฑ ุชูุณุญูุง ูุงุญููุง.</p>
    <div class="search" style="margin-top:8px">
      <button id="onbStart">ุงุจุฏุฃ</button>
      <button class="ghost" id="onbSkip">ุชุฎุทู</button>
    </div>
  </div>
</div>

<div class="snackbar" id="snack"><span id="snackMsg"></span><button id="snackUndo">ุชุฑุงุฌุน</button></div>

<script src="app.js?v=52"></script>
</body>
</html>
