<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¨ÙˆØ¯ÙŠ Ultra</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0e14"/>
<style>
:root{
  --bg:#0b0e14; --surface:#101521; --card:#141a2a; --muted:#8a92a6; --text:#eef1ff;
  --accent:#5b8cff; --green:#3ddc84; --red:#ff6b6b; --ring:#1f2a44; --border:#1a2236;
  --shadow:0 8px 20px rgba(0,0,0,.22);
}
[data-theme="light"]{
  --bg:#f7f9fd; --surface:#ffffff; --card:#ffffff; --muted:#55607a; --text:#0b0e14;
  --accent:#3d6dff; --green:#2dbd73; --red:#e05050; --ring:#dfe6ff; --border:#e7eaf5;
  --shadow:0 6px 16px rgba(0,0,0,.08);
}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Kufi Arabic',sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:16px;padding-bottom:80px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:var(--shadow)}
.title{font-weight:800;font-size:20px;margin:6px 0 12px}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,textarea,button,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);outline:none}
button{background:var(--accent);border:none;font-weight:700;letter-spacing:.2px}
button.ghost{background:transparent}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid var(--border);font-size:12px} th{color:var(--muted);text-align:right}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px} @media (max-width:700px){ .kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{padding:12px;border-radius:16px;background:var(--surface);border:1px solid var(--border)}
.kpi .h{font-size:12px;color:var(--muted)} .kpi .v{font-size:24px;font-weight:900} .delta{font-size:12px;margin-top:2px}.delta.up{color:var(--red)}.delta.down{color:var(--green)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px} @media (max-width:700px){ .grid{grid-template-columns:1fr}}
.ring{width:140px;height:140px;border-radius:50%;border:10px solid var(--ring);position:relative;display:flex;align-items:center;justify-content:center;margin:auto}
.ring>span{font-weight:900} .ring .fill{position:absolute;inset:-10px;border-radius:50%;border:10px solid var(--accent);clip-path:polygon(50% 50%, 50% 0, 50% 0);transform:rotate(-90deg)}
.toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between} .tag{font-size:11px;color:var(--muted)}
/* Bottom Tabs */
.tabs{position:fixed;bottom:0;left:0;right:0;background:var(--surface);border-top:1px solid var(--border);display:flex;gap:6px;padding:8px 12px;justify-content:space-between}
.tab{flex:1;padding:10px;border-radius:12px;border:1px solid transparent;background:transparent} .tab.active{background:var(--accent);color:#fff}
.view{display:none} .view.active{display:block}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:var(--surface);font-size:12px} .chip.active{background:var(--accent);color:#fff;border-color:transparent}
.search{display:flex;gap:8px;align-items:center}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="wrap">
  <div class="toolbar" style="margin:8px 4px 12px">
    <div>
      <h1 style="margin:0">Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†Ø¨ÙˆØ¯ÙŠ <span style="opacity:.6">Ultra</span></h1>
      <div class="tag">PWA â€” ÙŠØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ù…Ø±Ø©</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="btnInstall" class="ghost">ØªØ«Ø¨ÙŠØª ÙƒØªØ·Ø¨ÙŠÙ‚</button>
      <button id="btnTheme" class="ghost">ÙˆØ¶Ø¹: <span id="themeName">â€”</span></button>
    </div>
  </div>

  <!-- Dashboard -->
  <section class="view" id="view-dashboard">
    <div class="kpis">
      <div class="kpi"><div class="h">Ø¢Ø®Ø± ÙˆØ²Ù†</div><div class="v" id="kpiWeight">â€”</div><div class="delta" id="deltaWeight"></div></div>
      <div class="kpi"><div class="h">Ø¢Ø®Ø± Ø¯Ù‡ÙˆÙ† %</div><div class="v" id="kpiBodyFat">â€”</div><div class="delta" id="deltaBodyFat"></div></div>
      <div class="kpi"><div class="h">BMI</div><div class="v" id="kpiBMI">â€”</div></div>
      <div class="kpi"><div class="h">Ø§Ù„ØªÙ‚Ø¯Ù… Ù†Ø­Ùˆ Ø§Ù„Ù‡Ø¯Ù</div><div class="v" id="kpiGoal">â€”</div><div class="delta" id="deltaGoal"></div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title">Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</div>
      <div class="chips" style="margin-bottom:8px">
        <button class="chip active" data-range="all">Ø§Ù„ÙƒÙ„</button>
        <button class="chip" data-range="90">90 ÙŠÙˆÙ…</button>
        <button class="chip" data-range="30">30 ÙŠÙˆÙ…</button>
        <button class="chip" data-range="7">7 Ø£ÙŠØ§Ù…</button>
        <button class="chip" id="toggleAvg">Ù…ØªÙˆØ³Ø· 7 Ø£ÙŠØ§Ù…</button>
      </div>
      <canvas id="chart" height="280"></canvas>
      <p class="tag">Ø§Ù„ÙˆØ²Ù† Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØŒ ÙˆØ§Ù„Ø¯Ù‡ÙˆÙ† % Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ.</p>
    </div>
  </section>

  <!-- Add -->
  <section class="view" id="view-add">
    <div class="card">
      <div class="title">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø©</div>
      <div class="grid">
        <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="date" type="date"/></div>
        <div><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="weight" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>Ø¯Ù‡ÙˆÙ† %</label><input id="bodyFat" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>Ø¹Ø¶Ù„Ø§Øª (ÙƒØ¬Ù…)</label><input id="muscle" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>Ù…Ø§Ø¡ %</label><input id="water" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>Ø¯Ù‡ÙˆÙ† Ø­Ø´ÙˆÙŠØ©</label><input id="visceral" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ø±Ù‚ BMR</label><input id="bmr" type="number" inputmode="numeric" step="1"/></div>
        <div><label>BMI</label><input id="bmi" type="text" disabled/></div>
        <div style="grid-column: 1 / -1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="notes" rows="2" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ù…Ø«Ø§Ù„: Ù…Ø±Ø­Ù„Ø© ØªØ¯Ø±ÙŠØ¨/ØªØºÙŠÙŠØ± Ø¯Ø§ÙŠØª)"></textarea></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-preset="today">Ø§Ù„ÙŠÙˆÙ…</button>
        <button class="chip" data-preset="-1">Ø£Ù…Ø³</button>
        <button class="chip" data-preset="-7">Ù‚Ø¨Ù„ Ø£Ø³Ø¨ÙˆØ¹</button>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveBtn">Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
        <button class="ghost" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </section>

  <!-- Goals -->
  <section class="view" id="view-goals">
    <div class="card">
      <div class="title">Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù„ÙŠØ§Ù‚Ø©</div>
      <div class="grid">
        <div><label>Ù‡Ø¯Ù Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="goalWeight" type="number" step="0.1" inputmode="decimal"/></div>
        <div><label>Ù‡Ø¯Ù Ø§Ù„Ø¯Ù‡ÙˆÙ† %</label><input id="goalBodyFat" type="number" step="0.1" inputmode="decimal"/></div>
        <div><label>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (ÙƒØ¬Ù…/Ø£Ø³Ø¨ÙˆØ¹)</label><input id="goalWeekly" type="number" step="0.1" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: -0.5"/></div>
        <div><label>Ù…ÙˆØ¹Ø¯ Ù…Ø³ØªÙ‡Ø¯Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="goalDeadline" type="date"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveGoals">Ø­ÙØ¸ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</button>
        <button class="ghost" id="clearGoals">Ù…Ø³Ø­</button>
      </div>
      <p class="tag" id="etaText"></p>
    </div>
  </section>

  <!-- Water -->
  <section class="view" id="view-water">
    <div class="card">
      <div class="title">Ù…Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="ring"><div id="waterRing" class="fill"></div><span id="waterPct">0%</span></div>
      <div class="grid" style="margin-top:10px">
        <div><label>Ù‡Ø¯Ù Ø§Ù„Ù…Ø§Ø¡ (Ù…Ù„)</label><input id="waterGoal" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 3000"/></div>
        <div><label>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ù„)</label><input id="waterCustom" type="number" inputmode="numeric" placeholder="Ù…Ø«Ø§Ù„: 250"/></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-add="250">+250 Ù…Ù„</button>
        <button class="chip" data-add="500">+500 Ù…Ù„</button>
        <button class="chip" data-add="750">+750 Ù…Ù„</button>
        <button class="chip" id="addCustom">+ Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="waterReset" class="ghost" style="flex:1">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ÙŠÙˆÙ…</button>
        <button id="waterNotify" style="flex:1">ØªÙØ¹ÙŠÙ„ ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø§Ø¡</button>
      </div>
      <p class="tag">Ø§Ù„ØªØ°ÙƒÙŠØ± ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ÙØªØ­Ù‡. Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¹Ù„Ù‰ iOS Ù†Ø­ØªØ§Ø¬ Web Push (Ù…Ø´ Ù…ÙØ¹Ù‘Ù„ Ù‡Ù†Ø§ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ).</p>
      <div class="search" style="margin-top:6px">
        <button id="icsBtn" class="ghost" style="flex:1">ØªØ°ÙƒÙŠØ± ØªÙ‚ÙˆÙŠÙ… ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ† (ICS)</button>
      </div>
    </div>
  </section>

  <!-- History -->
  <section class="view" id="view-history">
    <div class="card">
      <div class="title">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</div>
      <div class="search" style="margin-bottom:8px">
        <input id="searchNotes" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."/>
        <div class="chips">
          <button class="chip active" data-range="all">Ø§Ù„ÙƒÙ„</button>
          <button class="chip" data-range="365">Ø³Ù†Ø©</button>
          <button class="chip" data-range="90">90</button>
          <button class="chip" data-range="30">30</button>
          <button class="chip" data-range="7">7</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table id="table">
          <thead><tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØ²Ù†</th><th>Ø¯Ù‡ÙˆÙ† %</th><th>Ø¹Ø¶Ù„Ø§Øª</th><th>Ù…Ø§Ø¡ %</th><th>Ø­Ø´ÙˆÙŠØ©</th><th>BMR</th><th>BMI</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="search" style="margin-top:8px">
        <button class="ghost" id="exportBtn">ØªØµØ¯ÙŠØ± JSON</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <button class="ghost" id="importBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
      </div>
    </div>
  </section>

  <!-- Settings -->
  <section class="view" id="view-settings">
    <div class="card">
      <div class="title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
      <div class="grid">
        <div><label>Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label><input id="height" type="number" inputmode="decimal" placeholder="Ù…Ø«Ø§Ù„: 173"/></div>
        <div><label>Ù‚ÙÙ„ PIN (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="pin" type="password" inputmode="numeric" minlength="4" maxlength="6" placeholder="4-6 Ø£Ø±Ù‚Ø§Ù…"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        <button class="ghost" id="clearAll">Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªØ­Ø°ÙŠØ±)</button>
      </div>
      <p class="tag">ØªÙØ®Ø²Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø·.</p>
    </div>
  </section>
</div>

<!-- Bottom Tabs -->
<nav class="tabs">
  <button class="tab" data-view="dashboard">Ù„ÙˆØ­Ø©</button>
  <button class="tab" data-view="add">Ø¥Ø¶Ø§ÙØ©</button>
  <button class="tab" data-view="goals">Ø£Ù‡Ø¯Ø§Ù</button>
  <button class="tab" data-view="water">Ù…Ø§Ø¡</button>
  <button class="tab" data-view="history">Ù‚Ø±Ø§Ø¡Ø§Øª</button>
  <button class="tab" data-view="settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</nav>

<script>
// ===== Storage Keys (v3) + Migration from older keys
const LS = {
  ENTRIES: 'inbody.entries.v3',
  HEIGHT: 'inbody.height.v3',
  GOALS: 'inbody.goals.v3',
  WATER: 'inbody.water.v3',
  THEME: 'inbody.theme.v3',
  PIN: 'inbody.pin.v3'
};
// Migrate from v1/v2 on first load
(function migrate(){
  if(localStorage.getItem(LS.ENTRIES)) return;
  const cands = ['inbody.entries.v2','inbody.entries.v1'];
  for(const k of cands){ const v = localStorage.getItem(k); if(v){ localStorage.setItem(LS.ENTRIES, v); break } }
  const h = localStorage.getItem('inbody.height.v2')||localStorage.getItem('inbody.height.v1'); if(h) localStorage.setItem(LS.HEIGHT, h);
  const g = localStorage.getItem('inbody.goals.v2')||localStorage.getItem('inbody.goals.v1'); if(g) localStorage.setItem(LS.GOALS, g);
  const w = localStorage.getItem('inbody.water.v2')||localStorage.getItem('inbody.water.v1'); if(w) localStorage.setItem(LS.WATER, w);
})();

// ===== Helpers
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function todayISO(){ return new Date().toISOString().slice(0,10) }
function parseF(v){ const x = parseFloat(v); return Number.isFinite(x)? x : null }
function uid(){ return Math.random().toString(36).slice(2) }
function nf(x){ return x==null? 'â€”' : Number(x).toFixed(1) }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
function load(key, fallback=null){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v) : fallback }catch{ return fallback } }

// ===== Tabs
const tabs = $$('.tab');
const views = ['dashboard','add','goals','water','history','settings'];
function show(v){ views.forEach(id => { const el = document.getElementById('view-'+id); if(el) el.classList.toggle('active', id===v) }); tabs.forEach(t=>t.classList.toggle('active', t.dataset.view===v)); location.hash = v; }
tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.view)));
window.addEventListener('hashchange', () => show(location.hash.replace('#','') || 'dashboard'));

// ===== Theme
function setTheme(name){
  document.documentElement.setAttribute('data-theme', name);
  save(LS.THEME, name);
  $('#themeName').textContent = (name === 'light'? 'ÙØ§ØªØ­' : 'ØºØ§Ù…Ù‚');
}
const pref = load(LS.THEME, (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'));
setTheme(pref);
$('#btnTheme').onclick = () => setTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light');

// ===== Install prompt
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; $('#btnInstall').disabled = false; });
$('#btnInstall').onclick = async () => { if (deferredPrompt){ deferredPrompt.prompt(); deferredPrompt = null; } };

// ===== Elements
const el = {
  date: $('#date'), weight: $('#weight'), bodyFat: $('#bodyFat'), muscle: $('#muscle'),
  water: $('#water'), visceral: $('#visceral'), bmr: $('#bmr'), bmi: $('#bmi'), notes: $('#notes'),
  saveBtn: $('#saveBtn'), cancelBtn: $('#cancelBtn'),
  kpiWeight: $('#kpiWeight'), kpiBodyFat: $('#kpiBodyFat'), kpiBMI: $('#kpiBMI'),
  deltaWeight: $('#deltaWeight'), deltaBodyFat: $('#deltaBodyFat'),
  kpiGoal: $('#kpiGoal'), deltaGoal: $('#deltaGoal'),
  goalWeight: $('#goalWeight'), goalBodyFat: $('#goalBodyFat'), goalWeekly: $('#goalWeekly'), goalDeadline: $('#goalDeadline'),
  saveGoals: $('#saveGoals'), clearGoals: $('#clearGoals'), etaText: $('#etaText'),
  waterGoal: $('#waterGoal'), waterCustom: $('#waterCustom'), addCustom: $('#addCustom'),
  waterRing: $('#waterRing'), waterPct: $('#waterPct'), waterReset: $('#waterReset'), waterNotify: $('#waterNotify'), icsBtn: $('#icsBtn'),
  searchNotes: $('#searchNotes'), tableBody: $('#table tbody'),
  exportBtn: $('#exportBtn'), importBtn: $('#importBtn'), importFile: $('#importFile'),
  height: $('#height'), pin: $('#pin'), saveSettings: $('#saveSettings'), clearAll: $('#clearAll'),
};

// ===== Height + BMI
function updateBMI(){
  const w = parseF(el.weight.value);
  const h = parseF(el.height.value)/100;
  el.bmi.value = (w && h) ? (w/(h*h)).toFixed(1) : '';
}
['weight','height'].forEach(id => document.addEventListener('input', (ev) => { if (ev.target.id === id) updateBMI() }));

// ===== Entries
function getEntries(){ return (load(LS.ENTRIES, [])).sort((a,b)=>a.date.localeCompare(b.date)) }
function saveEntries(list){ save(LS.ENTRIES, list) }
function resetForm(){ window.editingId = null; el.date.value = todayISO(); ['weight','bodyFat','muscle','water','visceral','bmr','notes'].forEach(id => el[id].value = ''); updateBMI(); }
function fillForm(e){ el.date.value = e.date; el.weight.value = e.weightKg ?? ''; el.bodyFat.value = e.bodyFatPct ?? ''; el.muscle.value = e.muscleKg ?? ''; el.water.value = e.waterPct ?? ''; el.visceral.value = e.visceralFat ?? ''; el.bmr.value = e.bmr ?? ''; el.notes.value = e.notes ?? ''; updateBMI(); show('add'); window.scrollTo({top:0,behavior:'smooth'}); }
el.saveBtn.onclick = () => {
  const list = getEntries();
  const obj = { id: (window.editingId || uid()), date: el.date.value, weightKg: parseF(el.weight.value), bodyFatPct: parseF(el.bodyFat.value), muscleKg: parseF(el.muscle.value), waterPct: parseF(el.water.value), visceralFat: parseF(el.visceral.value), bmr: el.bmr.value? parseInt(el.bmr.value): null, bmi: el.bmi.value? parseFloat(el.bmi.value): null, notes: el.notes.value?.trim() || '' };
  if (!obj.date) return alert('Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ®Ù‹Ø§'); if (obj.weightKg == null) return alert('Ø§Ù„ÙˆØ²Ù† Ù…Ø·Ù„ÙˆØ¨');
  const others = list.filter(x=>x.id!==obj.id); others.push(obj); others.sort((a,b)=>a.date.localeCompare(b.date));
  saveEntries(others); window.editingId = null; resetForm(); renderAll(); show('history');
};
el.cancelBtn.onclick = () => { window.editingId = null; resetForm() };
$$('.chip[data-preset]').forEach(c => c.onclick = () => { const p = c.dataset.preset; const dt = new Date(); if(p==='today'){} else { dt.setDate(dt.getDate()+Number(p)); } el.date.value = dt.toISOString().slice(0,10); });

// ===== KPIs + Chart
let chart, showAvg=false, range='all';
function computeMovingAvg(arr, n=7){
  const out = []; for(let i=0;i<arr.length;i++){ const w = arr.slice(Math.max(0,i-n+1), i+1).filter(x=>x!=null); if(!w.length){ out.push(null); } else { out.push(w.reduce((a,b)=>a+b,0)/w.length); } } return out;
}
function filterByRange(entries, days){
  if(days==='all') return entries;
  const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-Number(days));
  return entries.filter(e => new Date(e.date) >= cutoff);
}
function renderChart(){
  const all = getEntries();
  const entries = filterByRange(all, range);
  const labels = entries.map(e=>e.date);
  const weight = entries.map(e=>e.weightKg ?? null);
  const bodyFat = entries.map(e=>e.bodyFatPct ?? null);
  const weightAvg = showAvg ? computeMovingAvg(weight,7) : null;
  const ctx = document.getElementById('chart');
  if (!chart){
    chart = new Chart(ctx, { type:'line', data:{ labels, datasets:[
      { label:'Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)', data: weight, tension:.35, yAxisID:'y' },
      { label:'Ø¯Ù‡ÙˆÙ† %', data: bodyFat, tension:.35, yAxisID:'y1' },
      { label:'Ù…ØªÙˆØ³Ø· 7 Ø£ÙŠØ§Ù…', data: weightAvg||[], tension:.35, yAxisID:'y', borderDash:[6,4], hidden: !showAvg }
    ]}, options:{ responsive:true, scales:{ y:{ position:'right' }, y1:{ position:'left', grid:{ drawOnChartArea:false } } } });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = weight;
    chart.data.datasets[1].data = bodyFat;
    chart.data.datasets[2].data = weightAvg||[];
    chart.data.datasets[2].hidden = !showAvg;
    chart.update();
  }
}
$$('#view-dashboard .chip[data-range]').forEach(c => c.onclick = () => { $$('#view-dashboard .chip[data-range]').forEach(x=>x.classList.remove('active')); c.classList.add('active'); range = c.dataset.range; renderChart(); });
$('#toggleAvg').onclick = (e)=>{ showAvg=!showAvg; e.target.classList.toggle('active', showAvg); renderChart(); };

function renderKPIs(){
  const entries = getEntries(); const h = parseF(el.height.value)/100;
  const latest = entries[entries.length-1], prev = entries[entries.length-2];
  if (latest){
    el.kpiWeight.textContent = nf(latest.weightKg);
    el.kpiBodyFat.textContent = nf(latest.bodyFatPct);
    el.kpiBMI.textContent = (h && latest.weightKg)? (latest.weightKg/(h*h)).toFixed(1) : 'â€”';
    if (prev && prev.weightKg!=null){ const d=latest.weightKg-prev.weightKg; el.deltaWeight.textContent=`${d>0?'+':''}${d.toFixed(1)} ÙƒØ¬Ù… Ù…Ù† Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø©`; el.deltaWeight.className='delta '+(d>0?'up':d<0?'down':'') } else { el.deltaWeight.textContent='' }
    if (prev && prev.bodyFatPct!=null){ const d=latest.bodyFatPct-prev.bodyFatPct; el.deltaBodyFat.textContent=`${d>0?'+':''}${(d).toFixed(1)}Ùª`; el.deltaBodyFat.className='delta '+(d>0?'up':d<0?'down':'') } else { el.deltaBodyFat.textContent='' }
  } else { el.kpiWeight.textContent='â€”'; el.kpiBodyFat.textContent='â€”'; el.kpiBMI.textContent='â€”'; el.deltaWeight.textContent=''; el.deltaBodyFat.textContent='' }
  const g = loadGoals();
  if (g.weight && latest?.weightKg){ const diff = g.weight - latest.weightKg; el.kpiGoal.textContent = `${diff>0?'-':''}${Math.abs(diff).toFixed(1)} ÙƒØ¬Ù…`; el.deltaGoal.textContent = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù'; }
  else if (g.bodyFat && latest?.bodyFatPct){ const diff = g.bodyFat - latest.bodyFatPct; el.kpiGoal.textContent = `${diff>0?'-':''}${Math.abs(diff).toFixed(1)}Ùª`; el.deltaGoal.textContent = 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‡ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©'; }
  else { el.kpiGoal.textContent = 'â€”'; el.deltaGoal.textContent='' }
}

// ===== Goals
function loadGoals(){ return load(LS.GOALS, { weight: null, bodyFat: null, weekly: null, deadline: null }) }
function saveGoals(g){ save(LS.GOALS, g); renderGoals(g); renderKPIs() }
function renderGoals(g){
  el.goalWeight.value = g.weight ?? ''; el.goalBodyFat.value = g.bodyFat ?? ''; el.goalWeekly.value = g.weekly ?? ''; el.goalDeadline.value = g.deadline ?? '';
  const entries = getEntries(); const latest = entries[entries.length-1]; let txt='';
  if (latest && g.weight && g.weekly){ const weeks = Math.abs((latest.weightKg - g.weight) / g.weekly); txt = `ØªÙ‚Ø¯ÙŠØ±: ${weeks.toFixed(1)} Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ²Ù† Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù.` }
  el.etaText.textContent = txt;
}
el.saveGoals.onclick = () => { const g = loadGoals(); g.weight=parseF(el.goalWeight.value); g.bodyFat=parseF(el.goalBodyFat.value); g.weekly=parseF(el.goalWeekly.value); g.deadline=el.goalDeadline.value||null; saveGoals(g); };
el.clearGoals.onclick = () => { saveGoals({ weight:null, bodyFat:null, weekly:null, deadline:null }) };

// ===== Water
function waterState(){ const d = load(LS.WATER, null); const today = todayISO(); if (!d || d.date !== today){ return { date: today, intake: 0, goal: 3000 } } return d; }
function saveWater(s){ save(LS.WATER, s); renderWater(s) }
function renderWater(s){
  el.waterGoal.value = s.goal;
  const pct = Math.max(0, Math.min(100, Math.round((s.intake / Math.max(s.goal,1))*100)));
  el.waterPct.textContent = pct + '%';
  const deg = pct/100 * 360;
  el.waterRing.style.transform = `rotate(${deg-90}deg)`;
}
function addWater(ml){ const s = waterState(); s.intake = Math.max(0, s.intake + ml); saveWater(s); if ('Notification' in window && Notification.permission === 'granted'){ new Notification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø§Ø¡', { body: `Ø£Ø¶ÙØª ${ml} Ù…Ù„. Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${s.intake} / ${s.goal} Ù…Ù„` }) } }
$$('.chip[data-add]').forEach(b => b.onclick = () => { const ml = parseInt(b.dataset.add); if (ml>0) addWater(ml) });
el.addCustom.onclick = () => { const v = parseInt(el.waterCustom.value||'0'); if (v>0) addWater(v) };
el.waterGoal.addEventListener('input', () => { const s = waterState(); s.goal = parseInt(el.waterGoal.value||'0')||3000; saveWater(s) });
el.waterReset.onclick = () => { const s = waterState(); s.intake = 0; saveWater(s) };
let waterInterval = null;
el.waterNotify.onclick = async () => {
  if (!('Notification' in window)) return alert('Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª');
  let perm = Notification.permission; if (perm !== 'granted'){ perm = await Notification.requestPermission() } if (perm !== 'granted'){ return alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª') }
  if (waterInterval){ clearInterval(waterInterval); waterInterval = null; el.waterNotify.textContent = 'ØªÙØ¹ÙŠÙ„ ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø§Ø¡'; return }
  el.waterNotify.textContent = 'Ø¥ÙŠÙ‚Ø§Ù ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø§Ø¡';
  waterInterval = setInterval(() => { const s = waterState(); new Notification('Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ ğŸ’§', { body: `ØªÙ‚Ø¯Ù‘Ù…Ùƒ Ø§Ù„ÙŠÙˆÙ…: ${s.intake}/${s.goal} Ù…Ù„` }); }, 90*60*1000);
};
el.icsBtn.onclick = () => {
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//InBody Ultra//Water Reminder//AR
BEGIN:VEVENT
UID:${uid()}@inbody-ultra
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
SUMMARY:Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ ğŸ’§
DESCRIPTION:ØªØ°ÙƒÙŠØ± Ø¯ÙˆØ±ÙŠ Ø¨Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡.
RRULE:FREQ=DAILY;INTERVAL=1
DTSTART:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
DURATION:PT0M
BEGIN:VALARM
TRIGGER:-PT0M
REPEAT:1
DURATION:PT120M
ACTION:DISPLAY
DESCRIPTION:Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡
END:VALARM
END:VEVENT
END:VCALENDAR`.replace(/\n/g,'\r\n');
  const blob = new Blob([ics], {type:'text/calendar'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'water-reminder.ics'; a.click(); URL.revokeObjectURL(url);
};

// ===== History (filter + search)
let historyRange = 'all';
function renderTable(){
  const q = el.searchNotes.value.trim().toLowerCase();
  let entries = getEntries();
  if (historyRange !== 'all'){ const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-Number(historyRange)); entries = entries.filter(e => new Date(e.date) >= cutoff); }
  if (q) entries = entries.filter(e => (e.notes||'').toLowerCase().includes(q));
  el.tableBody.innerHTML = '';
  for (const e of entries){
    const tr = document.createElement('tr'); function td(v){ const x=document.createElement('td'); x.textContent=v; return x }
    tr.appendChild(td(e.date)); tr.appendChild(td(nf(e.weightKg))); tr.appendChild(td(nf(e.bodyFatPct))); tr.appendChild(td(nf(e.muscleKg))); tr.appendChild(td(nf(e.waterPct))); tr.appendChild(td(nf(e.visceralFat))); tr.appendChild(td(e.bmr ?? 'â€”')); tr.appendChild(td(e.bmi ?? 'â€”')); tr.appendChild(td(e.notes || 'â€”'));
    const actions = document.createElement('td'); actions.style.display='flex'; actions.style.gap='6px';
    const b1=document.createElement('button'); b1.textContent='ØªØ¹Ø¯ÙŠÙ„'; b1.className='ghost'; b1.onclick=()=>{ window.editingId=e.id; fillForm(e) };
    const b2=document.createElement('button'); b2.textContent='Ø­Ø°Ù'; b2.className='ghost'; b2.onclick=()=>{ if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŸ')){ const out = getEntries().filter(x=>x.id!==e.id); saveEntries(out); renderAll() } };
    actions.appendChild(b1); actions.appendChild(b2); tr.appendChild(actions); el.tableBody.appendChild(tr);
  }
}
$('#searchNotes').addEventListener('input', renderTable);
$$('#view-history .chip[data-range]').forEach(c => c.onclick = () => { $$('#view-history .chip[data-range]').forEach(x=>x.classList.remove('active')); c.classList.add('active'); historyRange = c.dataset.range; renderTable(); });

// ===== Export / Import
el.exportBtn.onclick = () => {
  const data = JSON.stringify({ heightCm: parseF(el.height.value)||null, goals: loadGoals(), water: load(LS.WATER, null), entries: getEntries() }, null, 2);
  const blob = new Blob([data], {type:'application/json'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `inbody-ultra-${todayISO()}.json`; a.click(); URL.revokeObjectURL(url);
};
el.importBtn.onclick = () => el.importFile.click();
el.importFile.onchange = (ev) => {
  const f = ev.target.files?.[0]; if(!f) return; const reader = new FileReader();
  reader.onload = () => { try{ const pkg = JSON.parse(reader.result); if (pkg.heightCm!=null) { el.height.value = pkg.heightCm; save(LS.HEIGHT, pkg.heightCm) } if (pkg.goals) { save(LS.GOALS, pkg.goals) } if (pkg.water) { save(LS.WATER, pkg.water) } if (Array.isArray(pkg.entries)) { save(LS.ENTRIES, pkg.entries) } renderAll(); }catch(e){ alert('Ù…Ù„Ù JSON ØºÙŠØ± ØµØ§Ù„Ø­') } };
  reader.readAsText(f);
};

// ===== Settings
function loadSettings(){ const h = load(LS.HEIGHT, null); if (h!=null) el.height.value = h; const p = load(LS.PIN, null); if (p) el.pin.value = p; }
el.saveSettings.onclick = () => { if (el.height.value) save(LS.HEIGHT, parseF(el.height.value)); if (el.pin.value && (el.pin.value.length<4 || el.pin.value.length>6)) return alert('PIN Ø¨ÙŠÙ† 4 Ùˆ6 Ø£Ø±Ù‚Ø§Ù…'); if (el.pin.value) save(LS.PIN, el.pin.value); alert('ØªÙ… Ø§Ù„Ø­ÙØ¸'); };
el.clearAll.onclick = () => { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠÙÙ…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡.')){ Object.values(LS).forEach(k => localStorage.removeItem(k)); location.reload(); } };

// ===== Init
function renderAll(){ renderKPIs(); renderChart(); renderTable(); renderGoals(loadGoals()); renderWater(waterState()); }
(function(){
  // PIN Gate (if set)
  const pin = load(LS.PIN, null);
  if (pin){
    const entered = prompt('Ø£Ø¯Ø®Ù„ PIN Ù„ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'); if (entered !== pin){ alert('PIN ØºÙŠØ± ØµØ­ÙŠØ­'); location.reload(); return; }
  }
  // set default date
  el.date.value = todayISO();
  loadSettings();
  show(location.hash.replace('#','') || 'dashboard');
  renderAll();
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js') }
})();
</script>
</body>
</html>
