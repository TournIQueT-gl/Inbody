<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>ูุชุงุจุนุฉ ุฅูุจูุฏู ุจุฑู</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0e14" />
  <style>
    :root {
      --bg:#0b0e14; --surface:#101521; --card:#141a2a; --muted:#8a92a6; --text:#eef1ff;
      --accent:#5b8cff; --green:#3ddc84; --red:#ff6b6b; --ring:#1f2a44; --border:#1a2236;
    }
    [data-theme="light"] {
      --bg:#f7f9fd; --surface:#ffffff; --card:#ffffff; --muted:#55607a; --text:#0b0e14;
      --accent:#3d6dff; --green:#2dbd73; --red:#e05050; --ring:#dfe6ff; --border:#e7eaf5;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,'Noto Kufi Arabic',sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.22)}
    .title{font-weight:800;font-size:20px;margin:6px 0 12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,textarea,button,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);outline:none}
    button{background:var(--accent);border:none;font-weight:700;letter-spacing:.2px}
    button.ghost{background:transparent}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid var(--border);font-size:12px}
    th{color:var(--muted);text-align:right}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{padding:12px;border-radius:16px;background:var(--surface);border:1px solid var(--border)}
    .kpi .h{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:24px;font-weight:900}
    .delta{font-size:12px;margin-top:2px}
    .delta.up{color:var(--red)} .delta.down{color:var(--green)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){ .kpis{grid-template-columns:repeat(2,1fr)} .grid{grid-template-columns:1fr} }
    .ring{width:140px;height:140px;border-radius:50%;border:10px solid var(--ring);position:relative;display:flex;align-items:center;justify-content:center;margin:auto}
    .ring > span{font-weight:900}
    .ring .fill{position:absolute;inset:-10px;border-radius:50%;border:10px solid var(--accent);clip-path:polygon(50% 50%, 50% 0, 50% 0);transform:rotate(-90deg)}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .tag{font-size:11px;color:var(--muted)}
    /* Tabs */
    .tabs{display:flex;gap:6px;overflow:auto;padding:6px 0}
    .tab{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);white-space:nowrap}
    .tab.active{background:var(--accent);color:white;border-color:transparent}
    .view{display:none}
    .view.active{display:block}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="toolbar" style="margin:8px 4px 12px">
      <div>
        <h1 style="margin:0">ูุชุงุจุนุฉ ุฅูุจูุฏู <span style="opacity:.6">ุจุฑู</span></h1>
        <div class="tag">Tabbed UI โ ุฃุณุฑุนุ ุฃูุธูุ ููุนูู ุฏูู ุฅูุชุฑูุช</div>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnInstall" class="ghost">ุชุซุจูุช ูุชุทุจูู</button>
        <button id="btnTheme" class="ghost">ูุถุน: <span id="themeName">โ</span></button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab" data-view="dashboard">ููุญุฉ</button>
      <button class="tab" data-view="add">ุฅุถุงูุฉ ูุฑุงุกุฉ</button>
      <button class="tab" data-view="goals">ุงูุฃูุฏุงู</button>
      <button class="tab" data-view="water">ุงููุงุก</button>
      <button class="tab" data-view="history">ุงููุฑุงุกุงุช</button>
      <button class="tab" data-view="settings">ุงูุฅุนุฏุงุฏุงุช</button>
    </div>

    <!-- Dashboard -->
    <section class="view" id="view-dashboard">
      <div class="kpis">
        <div class="kpi"><div class="h">ุขุฎุฑ ูุฒู</div><div class="v" id="kpiWeight">โ</div><div class="delta" id="deltaWeight"></div></div>
        <div class="kpi"><div class="h">ุขุฎุฑ ุฏููู %</div><div class="v" id="kpiBodyFat">โ</div><div class="delta" id="deltaBodyFat"></div></div>
        <div class="kpi"><div class="h">BMI</div><div class="v" id="kpiBMI">โ</div><div class="delta" id="deltaBMI"></div></div>
        <div class="kpi"><div class="h">ุงูุชูุฏู ูุญู ุงููุฏู</div><div class="v" id="kpiGoal">โ</div><div class="delta" id="deltaGoal"></div></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">ุงูุฑุณู ุงูุจูุงูู</div>
        <canvas id="chart" height="280"></canvas>
        <p class="tag">ุงููุฒู ุนูู ุงููุญูุฑ ุงูุฃุณุงุณูุ ูุงูุฏููู % ุนูู ุงููุญูุฑ ุงูุซุงููู.</p>
      </div>
    </section>

    <!-- Add -->
    <section class="view" id="view-add">
      <div class="card">
        <div class="title">ุฅุถุงูุฉ / ุชุนุฏูู ูุฑุงุกุฉ</div>
        <div class="grid">
          <div><label>ุงูุชุงุฑูุฎ</label><input id="date" type="date"/></div>
          <div><label>ุงููุฒู (ูุฌู)</label><input id="weight" type="number" inputmode="decimal" step="0.1"/></div>
          <div><label>ุฏููู %</label><input id="bodyFat" type="number" inputmode="decimal" step="0.1"/></div>
          <div><label>ุนุถูุงุช (ูุฌู)</label><input id="muscle" type="number" inputmode="decimal" step="0.1"/></div>
          <div><label>ูุงุก %</label><input id="water" type="number" inputmode="decimal" step="0.1"/></div>
          <div><label>ุฏููู ุญุดููุฉ</label><input id="visceral" type="number" inputmode="decimal" step="0.1"/></div>
          <div><label>ูุนุฏู ุงูุญุฑู BMR</label><input id="bmr" type="number" inputmode="numeric" step="1"/></div>
          <div><label>BMI</label><input id="bmi" type="text" disabled/></div>
          <div style="grid-column: 1 / -1"><label>ููุงุญุธุงุช</label><textarea id="notes" rows="2" placeholder="ุงุฎุชูุงุฑู (ูุซุงู: ูุฑุญูุฉ ุชุฏุฑูุจ/ุชุบููุฑ ุฏุงูุช)"></textarea></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveBtn">ุญูุธ ุงููุฑุงุกุฉ</button>
          <button class="ghost" id="cancelBtn">ุฅูุบุงุก</button>
        </div>
      </div>
    </section>

    <!-- Goals -->
    <section class="view" id="view-goals">
      <div class="card">
        <div class="title">ุฃูุฏุงู ุงูููุงูุฉ</div>
        <div class="grid">
          <div><label>ูุฏู ุงููุฒู (ูุฌู)</label><input id="goalWeight" type="number" step="0.1" inputmode="decimal"/></div>
          <div><label>ูุฏู ุงูุฏููู %</label><input id="goalBodyFat" type="number" step="0.1" inputmode="decimal"/></div>
          <div><label>ูุนุฏู ุงูุชุบููุฑ ุงูุฃุณุจูุนู (ูุฌู/ุฃุณุจูุน)</label><input id="goalWeekly" type="number" step="0.1" inputmode="decimal" placeholder="ูุซุงู: -0.5"/></div>
          <div><label>ููุนุฏ ูุณุชูุฏู (ุงุฎุชูุงุฑู)</label><input id="goalDeadline" type="date"/></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="saveGoals">ุญูุธ ุงูุฃูุฏุงู</button>
          <button class="ghost" id="clearGoals">ูุณุญ</button>
        </div>
        <p class="tag" id="etaText"></p>
      </div>
    </section>

    <!-- Water -->
    <section class="view" id="view-water">
      <div class="card">
        <div class="title">ูุงุก ุงูููู</div>
        <div class="ring"><div id="waterRing" class="fill"></div><span id="waterPct">0%</span></div>
        <div class="grid" style="margin-top:10px">
          <div><label>ูุฏู ุงููุงุก (ูู)</label><input id="waterGoal" type="number" inputmode="numeric" placeholder="ูุซุงู: 3000"/></div>
          <div><label>ุงููุดุฑูุจ ุงูุญุงูู (ูู)</label><input id="waterCustom" type="number" inputmode="numeric" placeholder="ูุซุงู: 250"/></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" data-add="250">+ 250 ูู</button>
          <button class="ghost" data-add="500">+ 500 ูู</button>
          <button class="ghost" data-add="750">+ 750 ูู</button>
          <button class="ghost" id="addCustom">+ ุฅุถุงูุฉ</button>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="waterReset" class="ghost" style="flex:1">ุฅุนุงุฏุฉ ุถุจุท ุงูููู</button>
          <button id="waterNotify" style="flex:1">ุชูุนูู ุชุฐููุฑ ุงููุงุก</button>
        </div>
        <p class="tag">ุงูุชุฐููุฑ ูุนูู ุฏุงุฎู ุงูุชุทุจูู ุนูุฏ ูุชุญู. ูุฅุดุนุงุฑุงุช ูู ุงูุฎูููุฉ ุนูู iOS ูุญุชุงุฌ Web Push (ุฎุงุฏู).</p>
        <div class="row" style="margin-top:6px">
          <button id="icsBtn" class="ghost" style="flex:1">ุชุฐููุฑ ุชูููู ูู ุณุงุนุชูู (ICS)</button>
        </div>
      </div>
    </section>

    <!-- History -->
    <section class="view" id="view-history">
      <div class="card">
        <div class="title">ุงููุฑุงุกุงุช</div>
        <div style="overflow-x:auto">
          <table id="table">
            <thead>
              <tr>
                <th>ุงูุชุงุฑูุฎ</th><th>ุงููุฒู</th><th>ุฏููู %</th><th>ุนุถูุงุช</th><th>ูุงุก %</th><th>ุญุดููุฉ</th><th>BMR</th><th>BMI</th><th>ููุงุญุธุงุช</th><th>ุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" id="exportBtn">ุชุตุฏูุฑ JSON</button>
          <input type="file" id="importFile" accept="application/json" style="display:none"/>
          <button class="ghost" id="importBtn">ุงุณุชูุฑุงุฏ</button>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section class="view" id="view-settings">
      <div class="card">
        <div class="title">ุงูุฅุนุฏุงุฏุงุช</div>
        <div class="grid">
          <div><label>ุงูุทูู (ุณู)</label><input id="height" type="number" inputmode="decimal" placeholder="ูุซุงู: 173"/></div>
        </div>
        <p class="tag">ููุณุชุฎุฏู ูุญุณุงุจ BMI ุชููุงุฆููุง.</p>
      </div>
    </section>

    <p class="tag" style="margin-top:12px;text-align:center">ูุตูุญุฉ: ุฎูุฐ ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูู ููุช ูุขุฎุฑ. ูุนูู ุฏูู ุฅูุชุฑูุช ุจุนุฏ ุฃูู ุฒูุงุฑุฉ.</p>
  </div>

<script>
// ===== Storage Keys
const LS = {
  ENTRIES: 'inbody.entries.v2',
  HEIGHT: 'inbody.height.v2',
  GOALS: 'inbody.goals.v2',
  WATER: 'inbody.water.v2',
  THEME: 'inbody.theme.v2'
};
// ===== Helpers
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function todayISO(){ return new Date().toISOString().slice(0,10) }
function parseF(v){ const x = parseFloat(v); return Number.isFinite(x)? x : null }
function uid(){ return Math.random().toString(36).slice(2) }
function nf(x){ return x==null? 'โ' : Number(x).toFixed(1) }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
function load(key, fallback=null){ try{ const v = localStorage.getItem(key); return v? JSON.parse(v) : fallback }catch{ return fallback } }
window.addEventListener('error', e => console.error('Error:', e.error || e.message));

// ===== Tabs (hash router)
const tabs = $$('.tab');
const views = {
  dashboard: $('#view-dashboard'),
  add: $('#view-add'),
  goals: $('#view-goals'),
  water: $('#view-water'),
  history: $('#view-history'),
  settings: $('#view-settings'),
};
function show(view){
  Object.values(views).forEach(v => v.classList.remove('active'));
  (views[view]||views.dashboard).classList.add('active');
  tabs.forEach(t => t.classList.toggle('active', t.dataset.view === view));
  location.hash = view;
}
tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.view)));
window.addEventListener('hashchange', () => show(location.hash.replace('#','') || 'dashboard'));

// ===== Theme
function setTheme(name){
  document.documentElement.setAttribute('data-theme', name);
  save(LS.THEME, name);
  $('#themeName').textContent = (name === 'light'? 'ูุงุชุญ' : 'ุบุงูู');
}
const pref = load(LS.THEME, (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark'));
setTheme(pref);
$('#btnTheme').onclick = () => setTheme(document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light');

// ===== Install prompt
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; $('#btnInstall').disabled = false; });
$('#btnInstall').onclick = async () => { if (deferredPrompt){ deferredPrompt.prompt(); deferredPrompt = null; } };

// ===== Elements map
const el = {
  // add form
  date: $('#date'), weight: $('#weight'), bodyFat: $('#bodyFat'), muscle: $('#muscle'),
  water: $('#water'), visceral: $('#visceral'), bmr: $('#bmr'), bmi: $('#bmi'), notes: $('#notes'),
  saveBtn: $('#saveBtn'), cancelBtn: $('#cancelBtn'),
  // dashboard KPIs
  kpiWeight: $('#kpiWeight'), deltaWeight: $('#deltaWeight'),
  kpiBodyFat: $('#kpiBodyFat'), deltaBodyFat: $('#deltaBodyFat'),
  kpiBMI: $('#kpiBMI'), deltaBMI: $('#deltaBMI'),
  kpiGoal: $('#kpiGoal'), deltaGoal: $('#deltaGoal'),
  // goals
  goalWeight: $('#goalWeight'), goalBodyFat: $('#goalBodyFat'), goalWeekly: $('#goalWeekly'), goalDeadline: $('#goalDeadline'),
  saveGoals: $('#saveGoals'), clearGoals: $('#clearGoals'), etaText: $('#etaText'),
  // water
  waterGoal: $('#waterGoal'), waterCustom: $('#waterCustom'), addCustom: $('#addCustom'),
  ring: $('#waterRing'), pct: $('#waterPct'), waterReset: $('#waterReset'), waterNotify: $('#waterNotify'), icsBtn: $('#icsBtn'),
  // history
  tableBody: $('#table tbody'),
  // settings
  height: $('#height'),
  // export/import
  exportBtn: $('#exportBtn'), importBtn: $('#importBtn'), importFile: $('#importFile'),
};

// ===== Height + BMI link
function updateBMI(){
  const w = parseF(el.weight.value);
  const h = parseF(el.height.value)/100;
  el.bmi.value = (w && h) ? (w/(h*h)).toFixed(1) : '';
}
['weight','height'].forEach(id => document.addEventListener('input', (ev) => { if (ev.target.id === id) updateBMI() }));

// ===== Water
function waterState(){
  const d = load(LS.WATER, null);
  const today = todayISO();
  if (!d || d.date !== today){ return { date: today, intake: 0, goal: 3000 } }
  return d;
}
function saveWater(s){ save(LS.WATER, s); renderWater(s) }
function renderWater(s){
  el.waterGoal.value = s.goal;
  const pct = Math.max(0, Math.min(100, Math.round((s.intake / Math.max(s.goal,1))*100)));
  el.pct.textContent = pct + '%';
  const deg = pct/100 * 360;
  el.ring.style.transform = `rotate(${deg-90}deg)`; // rotate fill only
}
$$('button[data-add]').forEach(b => b.onclick = () => { const ml = parseInt(b.dataset.add); if (ml>0) addWater(ml) });
el.addCustom.onclick = () => { const v = parseInt(el.waterCustom.value||'0'); if (v>0) addWater(v) };
el.waterGoal.addEventListener('input', () => { const s = waterState(); s.goal = parseInt(el.waterGoal.value||'0')||3000; saveWater(s) });
el.waterReset.onclick = () => { const s = waterState(); s.intake = 0; saveWater(s) };

function addWater(ml){
  const s = waterState();
  s.intake = Math.max(0, s.intake + ml);
  saveWater(s);
  if ('Notification' in window && Notification.permission === 'granted'){ new Notification('ุชู ุชุณุฌูู ุงููุงุก', { body: `ุฃุถูุช ${ml} ูู. ุงูุฅุฌูุงูู: ${s.intake} / ${s.goal} ูู` }) }
}
let waterInterval = null;
el.waterNotify.onclick = async () => {
  if (!('Notification' in window)) return alert('ุงููุชุตูุญ ูุง ูุฏุนู ุงูุฅุดุนุงุฑุงุช');
  let perm = Notification.permission;
  if (perm !== 'granted'){ perm = await Notification.requestPermission() }
  if (perm !== 'granted'){ return alert('ูู ูุชู ุงูุณูุงุญ ุจุงูุฅุดุนุงุฑุงุช') }
  if (waterInterval){ clearInterval(waterInterval); waterInterval = null; el.waterNotify.textContent = 'ุชูุนูู ุชุฐููุฑ ุงููุงุก'; return }
  el.waterNotify.textContent = 'ุฅููุงู ุชุฐููุฑ ุงููุงุก';
  waterInterval = setInterval(() => {
    const s = waterState();
    new Notification('ุงุดุฑุจ ูุงุก ๐ง', { body: `ุชูุฏููู ุงูููู: ${s.intake}/${s.goal} ูู` });
  }, 90 * 60 * 1000);
};
el.icsBtn.onclick = () => {
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//InBody Pro//Water Reminder//AR
BEGIN:VEVENT
UID:${uid()}@inbody-pro
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
SUMMARY:ุงุดุฑุจ ูุงุก ๐ง
DESCRIPTION:ุชุฐููุฑ ุฏูุฑู ุจุดุฑุจ ุงููุงุก.
RRULE:FREQ=DAILY;INTERVAL=1
DTSTART:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
DURATION:PT0M
BEGIN:VALARM
TRIGGER:-PT0M
REPEAT:1
DURATION:PT120M
ACTION:DISPLAY
DESCRIPTION:ุงุดุฑุจ ูุงุก
END:VALARM
END:VEVENT
END:VCALENDAR`.replace(/\n/g,'\r\n');
  const blob = new Blob([ics], {type:'text/calendar'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'water-reminder.ics'; a.click(); URL.revokeObjectURL(url);
};

// ===== Goals
function loadGoals(){ return load(LS.GOALS, { weight: null, bodyFat: null, weekly: null, deadline: null }) }
function saveGoals(g){ save(LS.GOALS, g); renderGoals(g); renderKPIs() }
function renderGoals(g){
  el.goalWeight.value = g.weight ?? '';
  el.goalBodyFat.value = g.bodyFat ?? '';
  el.goalWeekly.value = g.weekly ?? '';
  el.goalDeadline.value = g.deadline ?? '';
  const entries = getEntries();
  const latest = entries[entries.length-1];
  let txt = '';
  if (latest && g.weight && g.weekly){
    const weeks = Math.abs((latest.weightKg - g.weight) / g.weekly);
    txt = `ุชูุฏูุฑ ูุจุฏุฆู: ${weeks.toFixed(1)} ุฃุณุจูุน ูููุตูู ูููุฒู ุงููุณุชูุฏู.`
  }
  el.etaText.textContent = txt;
}
el.saveGoals.onclick = () => {
  const g = loadGoals();
  g.weight = parseF(el.goalWeight.value);
  g.bodyFat = parseF(el.goalBodyFat.value);
  g.weekly = parseF(el.goalWeekly.value);
  g.deadline = el.goalDeadline.value || null;
  saveGoals(g);
};
el.clearGoals.onclick = () => { saveGoals({ weight:null, bodyFat:null, weekly:null, deadline:null }) };

// ===== Entries
function getEntries(){ return (load(LS.ENTRIES, [])).sort((a,b)=>a.date.localeCompare(b.date)) }
function saveEntries(list){ save(LS.ENTRIES, list) }

function resetForm(){
  editingId = null;
  el.date.value = todayISO();
  ['weight','bodyFat','muscle','water','visceral','bmr','notes'].forEach(id => el[id].value = '');
  updateBMI();
}
function fillForm(e){
  el.date.value = e.date;
  el.weight.value = e.weightKg ?? '';
  el.bodyFat.value = e.bodyFatPct ?? '';
  el.muscle.value = e.muscleKg ?? '';
  el.water.value = e.waterPct ?? '';
  el.visceral.value = e.visceralFat ?? '';
  el.bmr.value = e.bmr ?? '';
  el.notes.value = e.notes ?? '';
  updateBMI();
  show('add');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

el.saveBtn.onclick = () => {
  const list = getEntries();
  const obj = {
    id: (window.editingId || uid()),
    date: el.date.value,
    weightKg: parseF(el.weight.value),
    bodyFatPct: parseF(el.bodyFat.value),
    muscleKg: parseF(el.muscle.value),
    waterPct: parseF(el.water.value),
    visceralFat: parseF(el.visceral.value),
    bmr: el.bmr.value? parseInt(el.bmr.value): null,
    bmi: el.bmi.value? parseFloat(el.bmi.value): null,
    notes: el.notes.value?.trim() || ''
  };
  if (!obj.date) return alert('ุงุฎุชุฑ ุชุงุฑูุฎูุง');
  if (obj.weightKg == null) return alert('ุงููุฒู ูุทููุจ');
  const others = list.filter(x=>x.id!==obj.id);
  others.push(obj); others.sort((a,b)=>a.date.localeCompare(b.date));
  saveEntries(others);
  window.editingId = null;
  resetForm(); renderAll(); show('history');
};
el.cancelBtn.onclick = () => { window.editingId = null; resetForm() };

// ===== Table & KPIs & Chart
let chart;
function renderTable(){
  const entries = getEntries();
  el.tableBody.innerHTML = '';
  for (const e of entries){
    const tr = document.createElement('tr');
    function td(v){ const x=document.createElement('td'); x.textContent=v; return x }
    tr.appendChild(td(e.date));
    tr.appendChild(td(nf(e.weightKg)));
    tr.appendChild(td(nf(e.bodyFatPct)));
    tr.appendChild(td(nf(e.muscleKg)));
    tr.appendChild(td(nf(e.waterPct)));
    tr.appendChild(td(nf(e.visceralFat)));
    tr.appendChild(td(e.bmr ?? 'โ'));
    tr.appendChild(td(e.bmi ?? 'โ'));
    tr.appendChild(td(e.notes || 'โ'));
    const actions = document.createElement('td'); actions.style.display='flex'; actions.style.gap='6px';
    const b1 = document.createElement('button'); b1.textContent='ุชุนุฏูู'; b1.className='ghost';
    b1.onclick = () => { window.editingId = e.id; fillForm(e) };
    const b2 = document.createElement('button'); b2.textContent='ุญุฐู'; b2.className='ghost';
    b2.onclick = () => { if (confirm('ุญุฐู ูุฐู ุงููุฑุงุกุฉุ')){ const out = getEntries().filter(x=>x.id!==e.id); saveEntries(out); renderAll() } };
    actions.appendChild(b1); actions.appendChild(b2);
    tr.appendChild(actions);
    el.tableBody.appendChild(tr);
  }
}
function renderKPIs(){
  const entries = getEntries();
  const h = parseF(el.height.value)/100;
  const latest = entries[entries.length-1], prev = entries[entries.length-2];
  if (latest){
    el.kpiWeight.textContent = nf(latest.weightKg);
    el.kpiBodyFat.textContent = nf(latest.bodyFatPct);
    el.kpiBMI.textContent = (h && latest.weightKg)? (latest.weightKg/(h*h)).toFixed(1) : 'โ';
    if (prev && prev.weightKg!=null){ const d=latest.weightKg-prev.weightKg; el.deltaWeight.textContent=`ููุงุฑูุฉ ุจุขุฎุฑ ูุฑุงุกุฉ: ${d>0?'+':''}${d.toFixed(1)} ูุฌู`; el.deltaWeight.className='delta '+(d>0?'up':d<0?'down':'') } else { el.deltaWeight.textContent='' }
    if (prev && prev.bodyFatPct!=null){ const d=latest.bodyFatPct-prev.bodyFatPct; el.deltaBodyFat.textContent=`${d>0?'+':''}${(d).toFixed(1)}ูช`; el.deltaBodyFat.className='delta '+(d>0?'up':d<0?'down':'') } else { el.deltaBodyFat.textContent='' }
  } else { el.kpiWeight.textContent='โ'; el.kpiBodyFat.textContent='โ'; el.kpiBMI.textContent='โ'; el.deltaWeight.textContent=''; el.deltaBodyFat.textContent='' }
  const g = loadGoals();
  if (g.weight && latest?.weightKg){ const diff = g.weight - latest.weightKg; el.kpiGoal.textContent = `${diff>0?'-':''}${Math.abs(diff).toFixed(1)} ูุฌู`; el.deltaGoal.textContent = 'ุงููุชุจูู ูููุตูู ูููุฒู ุงููุณุชูุฏู'; }
  else if (g.bodyFat && latest?.bodyFatPct){ const diff = g.bodyFat - latest.bodyFatPct; el.kpiGoal.textContent = `${diff>0?'-':''}${Math.abs(diff).toFixed(1)}ูช`; el.deltaGoal.textContent = 'ุงููุชุจูู ูููุตูู ููุณุจุฉ ุงูุฏููู ุงููุณุชูุฏูุฉ'; }
  else { el.kpiGoal.textContent = 'โ'; el.deltaGoal.textContent='' }
}
function renderChart(){
  const entries = getEntries();
  const labels = entries.map(e=>e.date);
  const weight = entries.map(e=>e.weightKg ?? null);
  const bodyFat = entries.map(e=>e.bodyFatPct ?? null);
  const ctx = document.getElementById('chart');
  if (!chart){
    chart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[
        { label:'ุงููุฒู (ูุฌู)', data: weight, tension:.35, yAxisID:'y' },
        { label:'ุฏููู %', data: bodyFat, tension:.35, yAxisID:'y1' }
      ]},
      options:{ responsive:true, scales:{ y:{ position:'right' }, y1:{ position:'left', grid:{ drawOnChartArea:false } } } }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = weight;
    chart.data.datasets[1].data = bodyFat;
    chart.update();
  }
}

// ===== Export / Import
$('#exportBtn').onclick = () => {
  const data = JSON.stringify({ heightCm: parseF(el.height.value)||null, goals: loadGoals(), water: load(LS.WATER, null), entries: getEntries() }, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `inbody-pro-${todayISO()}.json`; a.click(); URL.revokeObjectURL(url);
};
$('#importBtn').onclick = () => $('#importFile').click();
$('#importFile').onchange = (ev) => {
  const f = ev.target.files?.[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const pkg = JSON.parse(reader.result);
      if (pkg.heightCm) { el.height.value = pkg.heightCm; save(LS.HEIGHT, pkg.heightCm) }
      if (pkg.goals) { save(LS.GOALS, pkg.goals) }
      if (pkg.water) { save(LS.WATER, pkg.water) }
      if (Array.isArray(pkg.entries)) { save(LS.ENTRIES, pkg.entries) }
      renderAll();
    }catch(e){ alert('ููู JSON ุบูุฑ ุตุงูุญ') }
  };
  reader.readAsText(f);
};

// ===== Init
function renderAll(){ renderKPIs(); renderChart(); renderTable(); renderGoals(loadGoals()); renderWater(waterState()); }
(function(){
  // default date
  el.date.value = todayISO();
  // height
  const savedH = load(LS.HEIGHT, null);
  if (savedH){ el.height.value = savedH }
  el.height.addEventListener('input', () => save(LS.HEIGHT, parseF(el.height.value)));
  // routing
  show(location.hash.replace('#','') || 'dashboard');
  renderAll();
  if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js') }
})();
</script>
</body>
</html>
