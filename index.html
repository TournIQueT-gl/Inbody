
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>متابعة إنبودي Ultra</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0e14"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <!-- iOS splash (subset common) -->
  <link rel="apple-touch-startup-image" href="splash/splash-1170x2532.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="apple-touch-startup-image" href="splash/splash-1284x2778.png" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <link rel="stylesheet" href="styles.css?v=56">
  <script>
    async function ensureCharts(){ if(window.Chart) return; await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; s.onload=r; document.head.appendChild(s) }); await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js'; s.onload=r; document.head.appendChild(s) }) }
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js?v=56').then(reg=>{ reg.addEventListener('updatefound', ()=>{ const sw=reg.installing; sw.addEventListener('statechange', ()=>{ if(sw.state==='installed' && navigator.serviceWorker.controller) window.postMessage({type:'SW_UPDATED'}, '*') }) }) }) }
  </script>
</head>
<body>
<div class="wrap">
  <div class="toolbar" style="margin:8px 4px 12px">
    <div>
      <h1 style="margin:0">متابعة إنبودي <span style="opacity:.6">Ultra</span></h1>
      <div class="tag">PWA — يعمل دون إنترنت بعد أول مرة</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="btnInstall" class="ghost">تثبيت كتطبيق</button>
      <button id="btnTheme" class="ghost">وضع: <span id="themeName">—</span></button>
    </div>
  </div>

  <div id="updateBanner" class="update-banner" style="display:none">
    في إصدار جديد — <button id="reloadApp" class="ghost">تحديث الآن</button>
  </div>

  <!-- Dashboard -->
  <section class="view" id="view-dashboard">
    <div class="kpis">
      <div class="kpi"><div class="h">آخر وزن</div><div class="v" id="kpiWeight">—</div><div class="delta" id="deltaWeight"></div></div>
      <div class="kpi"><div class="h">آخر دهون %</div><div class="v" id="kpiBodyFat">—</div><div class="delta" id="deltaBodyFat"></div></div>
      <div class="kpi"><div class="h">BMI</div><div class="v" id="kpiBMI">—</div></div>
      <div class="kpi"><div class="h">ETA الهدف</div><div class="v" id="kpiETA">—</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">إضافة سريعة</div>
      <div class="quick">
        <button id="minusW" class="ghost">-0.2</button>
        <input id="qaWeight" type="number" inputmode="decimal" step="0.1" placeholder="وزن اليوم (كجم)">
        <button id="plusW" class="ghost">+0.2</button>
        <input id="qaBodyFat" type="number" inputmode="decimal" step="0.1" placeholder="دهون %">
        <button id="qaSave">حفظ</button>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-qa-add="250">+250 مل ماء</button>
        <button class="chip" data-qa-add="500">+500 مل</button>
        <button class="chip" data-qa-add="750">+750 مل</button>
        <button class="chip" id="qaInBody">قياس إنبودي اليوم</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">الرسم البياني</div>
      <div class="chips" style="margin-bottom:8px">
        <button class="chip active" data-range="all">الكل</button>
        <button class="chip" data-range="90">90</button>
        <button class="chip" data-range="30">30</button>
        <button class="chip" data-range="7">7</button>
        <button class="chip" id="toggleAvg">متوسط 7 أيام</button>
        <button class="chip" id="resetZoom">إعادة ضبط التكبير</button>
        <button class="chip" id="toggleW">إخفاء الوزن</button>
        <button class="chip" id="toggleBF">إخفاء الدهون%</button>
      </div>
      <div id="chartSkel" class="skel h180"></div>
      <canvas id="chart" height="260" aria-label="Chart" style="display:none"></canvas>
      <p class="tag">Goal line + Annotations • Zoom/Pan متاح.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">ملخص شهري</div>
      <div id="monthly" class="ins-cards"></div>
    </div>
  </section>

  <!-- Planner / Goals -->
  <section class="view" id="view-goals">
    <div class="card">
      <div class="title">أهداف وخطة أسبوع</div>
      <div class="grid">
        <div><label>هدف الوزن (كجم)</label><input id="goalWeight" type="number" step="0.1"/></div>
        <div><label>معدل أسبوعي (كجم/أسبوع)</label><input id="goalWeekly" type="number" step="0.1" placeholder="-0.5"/></div>
        <div><label>موعد مستهدف</label><input id="goalDeadline" type="date"/></div>
        <div><label>محاكاة المعدل</label><input id="simWeekly" type="range" min="-1.5" max="1.5" step="0.1" value="-0.5"></div>
      </div>
      <p class="tag">ETA حسب المحاكاة: <span id="simETA">—</span></p>
      <div class="title">خطة الأسبوع</div>
      <div class="chips" id="planner"></div>
      <div class="search" style="margin-top:8px">
        <button id="saveGoals">حفظ</button>
        <button class="ghost" id="clearGoals">مسح</button>
      </div>
    </div>
  </section>

  <!-- Add -->
  <section class="view" id="view-add"><div class="card"><div class="title">إضافة / تعديل قراءة</div>
    <div class="grid">
      <div><label>التاريخ</label><input id="date" type="date"/></div>
      <div><label>الوزن (كجم)</label><input id="weight" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>دهون %</label><input id="bodyFat" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>عضلات (كجم)</label><input id="muscle" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>ماء %</label><input id="water" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>دهون حشوية</label><input id="visceral" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>BMR</label><input id="bmr" type="number" inputmode="numeric" step="1"/></div>
      <div><label>BMI</label><input id="bmi" type="text" disabled/></div>
      <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="notes" rows="2"></textarea></div>
    </div>
    <div class="chips" style="margin-top:8px">
      <button class="chip" data-preset="today">اليوم</button>
      <button class="chip" data-preset="-1">أمس</button>
      <button class="chip" data-preset="-7">قبل أسبوع</button>
    </div>
    <div class="search" style="margin-top:8px">
      <button id="saveBtn">حفظ القراءة</button>
      <button class="ghost" id="cancelBtn">إلغاء</button>
      <button class="ghost" id="copyLast">انسخ آخر قراءة</button>
    </div>
    <div class="tag" id="autoCalcs">—</div>
  </div></section>

  <!-- Water -->
  <section class="view" id="view-water">
    <div class="card">
      <div class="title">ماء اليوم</div>
      <div class="ring"><div id="waterRing" class="fill"></div><span id="waterPct">0%</span></div>
      <div class="grid" style="margin-top:10px">
        <div><label>هدف الماء (مل)</label><input id="waterGoal" type="number" placeholder="3000"/></div>
        <div><label>المشروب الحالي (مل)</label><input id="waterCustom" type="number" placeholder="250"/></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-add="250">+250 مل</button>
        <button class="chip" data-add="500">+500 مل</button>
        <button class="chip" data-add="750">+750 مل</button>
        <button class="chip" id="addCustom">+ إضافة</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">ICS متقدم</div>
        <div class="grid">
          <div><label>من ساعة</label><input id="icsFrom" type="time" value="09:00"></div>
          <div><label>إلى ساعة</label><input id="icsTo" type="time" value="21:00"></div>
          <div><label>كل (دقيقة)</label><input id="icsEvery" type="number" value="90"></div>
        </div>
        <div class="search" style="margin-top:6px">
          <button id="icsAdvBtn" class="ghost">توليد ملف ICS ذكي</button>
        </div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="waterReset" class="ghost" style="flex:1">إعادة ضبط اليوم</button>
        <button id="waterNotify" style="flex:1">تفعيل تذكير الماء</button>
      </div>
    </div>
  </section>

  <!-- History (virtualized) -->
  <section class="view" id="view-history">
    <div class="card">
      <div class="title">القراءات</div>
      <div class="search" style="margin-bottom:8px">
        <input id="searchNotes" placeholder="ابحث في الملاحظات..."/>
        <div class="chips">
          <button class="chip active" data-range="all">الكل</button>
          <button class="chip" data-range="365">سنة</button>
          <button class="chip" data-range="90">90</button>
          <button class="chip" data-range="30">30</button>
          <button class="chip" data-range="7">7</button>
        </div>
      </div>

      <div class="row header">
        <div>التاريخ</div><div>وزن</div><div>دهون%</div><div>عضلات</div><div>ماء%</div><div>حشوية</div><div>BMR</div><div>BMI</div><div>ملاحظات</div><div>إجراءات</div>
      </div>
      <div id="vtable" class="vtable" aria-label="سجل القراءات"></div>

      <div class="search" style="margin-top:8px;gap:12px">
        <button class="ghost" id="exportBtn">تصدير JSON</button>
        <button class="ghost" id="exportCSVBtn">تصدير CSV</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <button class="ghost" id="importBtn">استيراد JSON</button>
        <input type="file" id="importCSVFile" accept=".csv,text/csv" style="display:none"/>
        <select id="csvTemplate">
          <option value="auto" selected>Auto-map</option>
          <option value="inbody">InBody CSV</option>
          <option value="miscale">Mi Scale CSV</option>
        </select>
        <button class="ghost" id="importCSVBtn">استيراد CSV</button>
        <button id="snapshotBtn">Snapshot HTML v2</button>
      </div>
    </div>
  </section>

  <!-- Settings -->
  <section class="view" id="view-settings">
    <div class="card">
      <div class="title">الإعدادات</div>
      <div class="grid">
        <div><label>الطول (سم)</label><input id="height" type="number" placeholder="173"/></div>
        <div><label>Accent</label><input id="accent" type="color" value="#5b8cff"/></div>
        <div><label>Radius</label><input id="radius" type="range" min="8" max="28" value="18"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveSettings">حفظ الإعدادات</button>
        <button class="ghost" id="clearAll">مسح كل البيانات (تحذير)</button>
        <button class="ghost" id="btnDiagnostics">تشخيص</button>
      </div>
      <p class="tag">تُخزن البيانات محليًا على جهازك فقط.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">الإنجازات</div>
      <div class="badges" id="badges"></div>
    </div>

    <div class="card" id="diagCard" style="display:none;margin-top:10px">
      <div class="title">Diagnostics</div>
      <div class="kv">
        <div>UA</div><div id="ua"></div>
        <div>Storage</div><div id="lsOK"></div>
        <div>Notifications</div><div id="notif"></div>
        <div>SW</div><div id="sw"></div>
      </div>
    </div>
  </section>
</div>

<nav class="tabs" role="tablist">
  <button class="tab" data-view="dashboard" role="tab">لوحة</button>
  <button class="tab" data-view="add" role="tab">إضافة</button>
  <button class="tab" data-view="goals" role="tab">أهداف</button>
  <button class="tab" data-view="water" role="tab">ماء</button>
  <button class="tab" data-view="history" role="tab">قراءات</button>
  <button class="tab" data-view="settings" role="tab">إعدادات</button>
</nav>

<div id="toast" class="toast"></div>

<script src="app.js?v=56"></script>
<script src="worker.js?v=56" type="text/worker-placeholder"></script>
</body>
</html>
