<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>متابعة إنبودي Ultra (Safe)</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0e14"/>
<link rel="stylesheet" href="styles.css?v=5">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// hard-bust old service workers on first load of v5
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.getRegistrations().then(rs => Promise.all(rs.map(r => r.unregister()))).then(()=>{
    navigator.serviceWorker.register('sw.js?v=5');
  });
}
</script>
</head>
<body>
<div class="wrap">
  <div class="toolbar" style="margin:8px 4px 12px">
    <div>
      <h1 style="margin:0">متابعة إنبودي <span style="opacity:.6">Ultra</span></h1>
      <div class="tag">PWA — يعمل دون إنترنت بعد أول مرة</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="btnInstall" class="ghost">تثبيت كتطبيق</button>
      <button id="btnTheme" class="ghost">وضع: <span id="themeName">—</span></button>
    </div>
  </div>

  <section class="view" id="view-dashboard">
    <div class="kpis">
      <div class="kpi"><div class="h">آخر وزن</div><div class="v" id="kpiWeight">—</div><div class="delta" id="deltaWeight"></div></div>
      <div class="kpi"><div class="h">آخر دهون %</div><div class="v" id="kpiBodyFat">—</div><div class="delta" id="deltaBodyFat"></div></div>
      <div class="kpi"><div class="h">BMI</div><div class="v" id="kpiBMI">—</div></div>
      <div class="kpi"><div class="h">التقدم نحو الهدف</div><div class="v" id="kpiGoal">—</div><div class="delta" id="deltaGoal"></div></div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="title">الرسم البياني</div>
      <div class="chips" style="margin-bottom:8px">
        <button class="chip active" data-range="all">الكل</button>
        <button class="chip" data-range="90">90 يوم</button>
        <button class="chip" data-range="30">30 يوم</button>
        <button class="chip" data-range="7">7 أيام</button>
        <button class="chip" id="toggleAvg">متوسط 7 أيام</button>
      </div>
      <canvas id="chart" height="280"></canvas>
      <p class="tag">الوزن على المحور الأساسي، والدهون % على المحور الثانوي.</p>
    </div>
  </section>

  <section class="view" id="view-add">
    <div class="card">
      <div class="title">إضافة / تعديل قراءة</div>
      <div class="grid">
        <div><label>التاريخ</label><input id="date" type="date"/></div>
        <div><label>الوزن (كجم)</label><input id="weight" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>دهون %</label><input id="bodyFat" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>عضلات (كجم)</label><input id="muscle" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>ماء %</label><input id="water" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>دهون حشوية</label><input id="visceral" type="number" inputmode="decimal" step="0.1"/></div>
        <div><label>معدل الحرق BMR</label><input id="bmr" type="number" inputmode="numeric" step="1"/></div>
        <div><label>BMI</label><input id="bmi" type="text" disabled/></div>
        <div style="grid-column: 1 / -1"><label>ملاحظات</label><textarea id="notes" rows="2" placeholder="اختياري (مثال: مرحلة تدريب/تغيير دايت)"></textarea></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-preset="today">اليوم</button>
        <button class="chip" data-preset="-1">أمس</button>
        <button class="chip" data-preset="-7">قبل أسبوع</button>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveBtn">حفظ القراءة</button>
        <button class="ghost" id="cancelBtn">إلغاء</button>
      </div>
    </div>
  </section>

  <section class="view" id="view-goals">
    <div class="card">
      <div class="title">أهداف اللياقة</div>
      <div class="grid">
        <div><label>هدف الوزن (كجم)</label><input id="goalWeight" type="number" step="0.1" inputmode="decimal"/></div>
        <div><label>هدف الدهون %</label><input id="goalBodyFat" type="number" step="0.1" inputmode="decimal"/></div>
        <div><label>معدل التغيير الأسبوعي (كجم/أسبوع)</label><input id="goalWeekly" type="number" step="0.1" inputmode="decimal" placeholder="مثال: -0.5"/></div>
        <div><label>موعد مستهدف (اختياري)</label><input id="goalDeadline" type="date"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveGoals">حفظ الأهداف</button>
        <button class="ghost" id="clearGoals">مسح</button>
      </div>
      <p class="tag" id="etaText"></p>
    </div>
  </section>

  <section class="view" id="view-water">
    <div class="card">
      <div class="title">ماء اليوم</div>
      <div class="ring"><div id="waterRing" class="fill"></div><span id="waterPct">0%</span></div>
      <div class="grid" style="margin-top:10px">
        <div><label>هدف الماء (مل)</label><input id="waterGoal" type="number" inputmode="numeric" placeholder="مثال: 3000"/></div>
        <div><label>المشروب الحالي (مل)</label><input id="waterCustom" type="number" inputmode="numeric" placeholder="مثال: 250"/></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-add="250">+250 مل</button>
        <button class="chip" data-add="500">+500 مل</button>
        <button class="chip" data-add="750">+750 مل</button>
        <button class="chip" id="addCustom">+ إضافة</button>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="waterReset" class="ghost" style="flex:1">إعادة ضبط اليوم</button>
        <button id="waterNotify" style="flex:1">تفعيل تذكير الماء</button>
      </div>
      <p class="tag">التذكير يعمل داخل التطبيق عند فتحه. لا إشعارات خلفية.</p>
      <div class="search" style="margin-top:6px">
        <button id="icsBtn" class="ghost" style="flex:1">تذكير تقويم كل ساعتين (ICS)</button>
      </div>
    </div>
  </section>

  <section class="view" id="view-history">
    <div class="card">
      <div class="title">القراءات</div>
      <div class="search" style="margin-bottom:8px">
        <input id="searchNotes" placeholder="ابحث في الملاحظات..."/>
        <div class="chips">
          <button class="chip active" data-range="all">الكل</button>
          <button class="chip" data-range="365">سنة</button>
          <button class="chip" data-range="90">90</button>
          <button class="chip" data-range="30">30</button>
          <button class="chip" data-range="7">7</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table id="table">
          <thead><tr>
            <th>التاريخ</th><th>الوزن</th><th>دهون %</th><th>عضلات</th><th>ماء %</th><th>حشوية</th><th>BMR</th><th>BMI</th><th>ملاحظات</th><th>إجراءات</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="search" style="margin-top:8px">
        <button class="ghost" id="exportBtn">تصدير JSON</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <button class="ghost" id="importBtn">استيراد</button>
      </div>
    </div>
  </section>

  <section class="view" id="view-settings">
    <div class="card">
      <div class="title">الإعدادات</div>
      <div class="grid">
        <div><label>الطول (سم)</label><input id="height" type="number" inputmode="decimal" placeholder="مثال: 173"/></div>
        <div><label>قفل PIN (اختياري)</label><input id="pin" type="password" inputmode="numeric" minlength="4" maxlength="6" placeholder="4-6 أرقام"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveSettings">حفظ الإعدادات</button>
        <button class="ghost" id="clearAll">مسح كل البيانات (تحذير)</button>
      </div>
      <p class="tag">تُخزن البيانات محليًا على جهازك فقط.</p>
    </div>
  </section>
</div>

<nav class="tabs">
  <button class="tab" data-view="dashboard">لوحة</button>
  <button class="tab" data-view="add">إضافة</button>
  <button class="tab" data-view="goals">أهداف</button>
  <button class="tab" data-view="water">ماء</button>
  <button class="tab" data-view="history">قراءات</button>
  <button class="tab" data-view="settings">إعدادات</button>
</nav>

<script src="safe-app.js?v=5"></script>
</body>
</html>