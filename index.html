
<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
  <title>متابعة إنبودي Ultra</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b0e14"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css?v=53">
  <script>
    // Lazy-load charts & plugins
    async function ensureCharts(){ if(window.Chart) return; await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chart.js'; s.onload=r; document.head.appendChild(s) }); await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js'; s.onload=r; document.head.appendChild(s) }); }
    async function ensurePDF(){ if(window.jspdf) return; await new Promise(r=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'; s.onload=r; document.head.appendChild(s) }); }
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('sw.js?v=53').then(reg=>{ reg.addEventListener('updatefound', ()=>{ const sw=reg.installing; sw.addEventListener('statechange', ()=>{ if(sw.state==='installed' && navigator.serviceWorker.controller){ window.postMessage({type:'SW_UPDATED'}, '*') } }) }) }) }
  </script>
</head>
<body>
<div class="wrap">
  <div class="toolbar" style="margin:8px 4px 12px">
    <div>
      <h1 style="margin:0">متابعة إنبودي <span style="opacity:.6">Ultra</span></h1>
      <div class="tag">PWA — يعمل دون إنترنت بعد أول مرة</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="btnLang" class="ghost">EN</button>
      <button id="btnInstall" class="ghost">تثبيت كتطبيق</button>
      <button id="btnTheme" class="ghost">وضع: <span id="themeName">—</span></button>
    </div>
  </div>

  <div id="updateBanner" class="update-banner" style="display:none">
    في إصدار جديد — <button id="reloadApp" class="ghost">تحديث الآن</button>
  </div>

  <!-- Dashboard -->
  <section class="view" id="view-dashboard">
    <div class="kpis">
      <div class="kpi"><div class="h">آخر وزن</div><div class="v" id="kpiWeight">—</div><div class="delta" id="deltaWeight"></div></div>
      <div class="kpi"><div class="h">آخر دهون %</div><div class="v" id="kpiBodyFat">—</div><div class="delta" id="deltaBodyFat"></div></div>
      <div class="kpi"><div class="h">BMI</div><div class="v" id="kpiBMI">—</div></div>
      <div class="kpi"><div class="h">ETA الهدف</div><div class="v" id="kpiETA">—</div></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">إضافة سريعة</div>
      <div class="quick">
        <input id="qaWeight" type="number" inputmode="decimal" step="0.1" placeholder="وزن اليوم (كجم)">
        <input id="qaBodyFat" type="number" inputmode="decimal" step="0.1" placeholder="دهون % (اختياري)">
        <button id="qaSave">حفظ فوري</button>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-qa-add="250">+250 مل ماء</button>
        <button class="chip" data-qa-add="500">+500 مل</button>
        <button class="chip" data-qa-add="750">+750 مل</button>
        <button class="chip" id="qaInBody">قياس إنبودي اليوم</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">الرسم البياني</div>
      <div class="chips" style="margin-bottom:8px">
        <button class="chip active" data-range="all">الكل</button>
        <button class="chip" data-range="90">90</button>
        <button class="chip" data-range="30">30</button>
        <button class="chip" data-range="7">7</button>
        <button class="chip" id="toggleAvg">متوسط 7 أيام</button>
        <button class="chip" id="resetZoom">إعادة ضبط التكبير</button>
      </div>
      <canvas id="chart" height="260" aria-label="Chart"></canvas>
      <p class="tag">Zoom/Pan متاح — استخدم قرصة أو عجلة.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">مؤشرات ذكية</div>
      <div class="badges" id="insightsBadges"></div>
    </div>
  </section>

  <!-- Add / Goals / Water / History from previous versions are present via JS build -->

  <section class="view" id="view-add"><div class="card"><div class="title">إضافة / تعديل قراءة</div>
    <div class="grid">
      <div><label>التاريخ</label><input id="date" type="date"/></div>
      <div><label>الوزن (كجم)</label><input id="weight" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>دهون %</label><input id="bodyFat" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>عضلات (كجم)</label><input id="muscle" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>ماء %</label><input id="water" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>دهون حشوية</label><input id="visceral" type="number" inputmode="decimal" step="0.1"/></div>
      <div><label>BMR</label><input id="bmr" type="number" inputmode="numeric" step="1"/></div>
      <div><label>BMI</label><input id="bmi" type="text" disabled/></div>
      <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="notes" rows="2"></textarea></div>
    </div>
    <div class="chips" style="margin-top:8px">
      <button class="chip" data-preset="today">اليوم</button>
      <button class="chip" data-preset="-1">أمس</button>
      <button class="chip" data-preset="-7">قبل أسبوع</button>
    </div>
    <div class="search" style="margin-top:8px">
      <button id="saveBtn">حفظ القراءة</button>
      <button class="ghost" id="cancelBtn">إلغاء</button>
      <button class="ghost" id="copyLast">انسخ آخر قراءة</button>
    </div>
    <div class="tag" id="autoCalcs">—</div>
  </div></section>

  <section class="view" id="view-goals">
    <div class="card">
      <div class="title">أهداف اللياقة</div>
      <div class="grid">
        <div><label>هدف الوزن (كجم)</label><input id="goalWeight" type="number" step="0.1"/></div>
        <div><label>هدف الدهون %</label><input id="goalBodyFat" type="number" step="0.1"/></div>
        <div><label>معدل التغيير الأسبوعي</label><input id="goalWeekly" type="number" step="0.1" placeholder="-0.5"/></div>
        <div><label>موعد مستهدف</label><input id="goalDeadline" type="date"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveGoals">حفظ الأهداف</button>
        <button class="ghost" id="clearGoals">مسح</button>
      </div>
      <p class="tag" id="etaText"></p>
    </div>
  </section>

  <section class="view" id="view-water">
    <div class="card">
      <div class="title">ماء اليوم</div>
      <div class="ring"><div id="waterRing" class="fill"></div><span id="waterPct">0%</span></div>
      <div class="grid" style="margin-top:10px">
        <div><label>هدف الماء (مل)</label><input id="waterGoal" type="number" placeholder="3000"/></div>
        <div><label>المشروب الحالي (مل)</label><input id="waterCustom" type="number" placeholder="250"/></div>
      </div>
      <div class="chips" style="margin-top:8px">
        <button class="chip" data-add="250">+250 مل</button>
        <button class="chip" data-add="500">+500 مل</button>
        <button class="chip" data-add="750">+750 مل</button>
        <button class="chip" id="addCustom">+ إضافة</button>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">Hydration Coach</div>
        <div class="search"><button id="btnSuggestWater" class="ghost">اقترح هدف حسب وزني</button><span id="coachMsg" class="tag"></span></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">إعدادات التذكير</div>
        <div class="grid">
          <div><label>فاصل التذكير</label><select id="waterInterval"><option value="60">60</option><option value="90" selected>90</option><option value="120">120</option></select></div>
          <div><label>ساعات الصمت (من)</label><input id="quietStart" type="time" value="22:00"></div>
          <div><label>ساعات الصمت (إلى)</label><input id="quietEnd" type="time" value="08:00"></div>
        </div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="waterReset" class="ghost" style="flex:1">إعادة ضبط اليوم</button>
        <button id="waterNotify" style="flex:1">تفعيل تذكير الماء</button>
      </div>
      <div class="search" style="margin-top:6px">
        <button id="icsBtn" class="ghost" style="flex:1">تذكير تقويم كل ساعتين (ICS)</button>
      </div>
    </div>
  </section>

  <section class="view" id="view-history">
    <div class="card">
      <div class="title">القراءات</div>
      <div class="search" style="margin-bottom:8px">
        <input id="searchNotes" placeholder="ابحث في الملاحظات..."/>
        <div class="chips">
          <button class="chip active" data-range="all">الكل</button>
          <button class="chip" data-range="365">سنة</button>
          <button class="chip" data-range="90">90</button>
          <button class="chip" data-range="30">30</button>
          <button class="chip" data-range="7">7</button>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table id="table" aria-label="سجل القراءات">
          <thead><tr>
            <th>التاريخ</th><th>الوزن</th><th>دهون %</th><th>عضلات</th><th>ماء %</th><th>حشوية</th><th>BMR</th><th>BMI</th><th>ملاحظات</th><th>إجراءات</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="search" style="margin-top:8px;gap:12px">
        <button class="ghost" id="exportBtn">تصدير JSON</button>
        <button class="ghost" id="exportCSVBtn">تصدير CSV</button>
        <input type="file" id="importFile" accept="application/json" style="display:none"/>
        <button class="ghost" id="importBtn">استيراد JSON</button>
        <input type="file" id="importCSVFile" accept=".csv,text/csv" style="display:none"/>
        <select id="csvTemplate">
          <option value="auto" selected>Auto-map</option>
          <option value="inbody">InBody CSV</option>
          <option value="miscale">Mi Scale CSV</option>
        </select>
        <button class="ghost" id="importCSVBtn">استيراد CSV</button>
        <button id="snapshotBtn">Snapshot HTML</button>
      </div>
      <p class="tag" id="pagingInfo"></p>
    </div>
  </section>

  <section class="view" id="view-settings">
    <div class="card">
      <div class="title">الإعدادات</div>
      <div class="grid">
        <div><label>الطول (سم)</label><input id="height" type="number" placeholder="173"/></div>
        <div><label>Accent</label><input id="accent" type="color" value="#5b8cff"/></div>
        <div><label>Radius</label><input id="radius" type="range" min="8" max="28" value="18"/></div>
      </div>
      <div class="search" style="margin-top:8px">
        <button id="saveSettings">حفظ الإعدادات</button>
        <button class="ghost" id="clearAll">مسح كل البيانات (تحذير)</button>
        <button class="ghost" id="btnDiagnostics">تشخيص</button>
      </div>
      <p class="tag">تُخزن البيانات محليًا على جهازك فقط.</p>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="title">الإنجازات</div>
      <div class="badges" id="badges"></div>
    </div>

    <div class="card" id="diagCard" style="display:none;margin-top:10px">
      <div class="title">Diagnostics</div>
      <div class="kv">
        <div>UA</div><div id="ua"></div>
        <div>localStorage</div><div id="lsOK"></div>
        <div>Notifications</div><div id="notif"></div>
        <div>SW</div><div id="sw"></div>
      </div>
    </div>
  </section>
</div>

<nav class="tabs" role="tablist">
  <button class="tab" data-view="dashboard" role="tab">لوحة</button>
  <button class="tab" data-view="add" role="tab">إضافة</button>
  <button class="tab" data-view="goals" role="tab">أهداف</button>
  <button class="tab" data-view="water" role="tab">ماء</button>
  <button class="tab" data-view="history" role="tab">قراءات</button>
  <button class="tab" data-view="settings" role="tab">إعدادات</button>
</nav>

<script src="app.js?v=53"></script>
</body>
</html>
